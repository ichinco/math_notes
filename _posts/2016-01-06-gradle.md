---

layout: post
title: Gradle Plugin for Docker
tags: gradle, docker, automation, hacking

---

We have been trying out [Gradle](https://www.gradle.org) at my work place, 
and I find it a convenient and well-balanced build tool. However, the one 
thing that I wanted and I have not yet been able to figure out with other 
Gradle plugins is how to properly integrate my Docker build/run steps. 
I think my use-case is actually pretty simple. All I really wanted to be able
to do is:

```groovy
// build an image
// equivalent of docker build -f ./Dockerfile -t my-image-name:${version} .
task build(type:DockerBuild) {
    name = "my-image-name"
    tag = "${version}"
    file = "./Dockerfile"
    
    outputs.image = DockerImage("my-image-name:${version}")
}

// publishes
task publish(type:DockerPublish) {
    imageName = ""
    credentials = {
        login = "..."
        password = "..."
    }
}

// run the container image
// almost equivalent to 
//
// docker run -e A=foo -e B=bar \
//   -n my-image my-image-name:${version} run --my app
task run(type:DockerRun, dependsOn:Build) {
    waitTill {
        // groovy thing 
    }
    
    image = "my-image-name"
    tag = "${version}"
    name = "my-image"
    environments = [
        A: 'foo',
        B: 'bar'
    ]
    
    commands = ['run','--my','app']
    
    doLast {
        // do something next?
    }
}

// destroy the build
task teardown(type:DockerStop) {
    name = "my-image-name"
}
```

Such that when I run

```bash
gradle run
```

It will build a Docker image called `my-image-name:${version}`. More 
importantly, it will be up-to-date whenever the image does not need
to be re-built.

We are fairly confident that there is a Gradle plugin that has the above
features but with a slightly different syntax. The closest we can find
is the [Docker Gradle plugin by Gesellix](https://github.com/gesellix/gradle-docker-plugin).
While not mentioning specifically what we find to be missing,
We do want to say that the allure of
trying to build a Gradle plugin is strong enough that we are willing to
intentionally cater towards this oversight and build this plugin 
ourselves. There are enough meaty lessons to be learnt along the way
that we think that it is definitely worthwhile to spend the time to figure
these lessons out.

Well, let's get to it. This blog will serve as a walk-through of how
to build a gradle plugin in Scala, and we hope it will be useful for anyone
looking to build Gradle plugins for their own purposes (not that we
need more of them). One can find the source code at [my Github repo
for the project.](https://github.com/evilwire/docker-gradle-plugin)

We will shamelessly use Gesellix's Docker plugin code as guide. In fact,
short of crediting Gesellix of having done it first, all ideas here, 
especially those pertaining to Docker and Gradle are mere 
transliterations of Groovy to Scala with minor code organisation changes
that, arguably, are for the better.

## Pre-requisites

To keep this blog at a reasonable length, we assume that the reader
has some familiarity with the following concepts

- How Gradle Works
- Programming in Scala
- Java Package Management
- Docker tooling (e.g. `docker build`, `docker-compose`)

Unfortunately, each of these topics are too lengthy in it of 
themselves to be covered fully, we provide the following references
as a way to save on the digital ink:

- **Gradle User Guide** - 
  [https://docs.gradle.org/current/userguide/userguide.html](https://docs.gradle.org/current/userguide/userguide.html)
- **Gradle's Authoring Plugin (in Groovy)** - 
  [https://docs.gradle.org/current/userguide/custom_plugins.html](https://docs.gradle.org/current/userguide/custom_plugins.html)
- **Gradle's Task API (JavaDoc)** - 
  [https://docs.gradle.org/current/javadoc/org/gradle/api/Task.html](https://docs.gradle.org/current/javadoc/org/gradle/api/Task.html)
- **Scala For the Impatient (Book)** - 
  [https://www.amazon.com/Scala-Impatient-Cay-S-Horstmann/dp/0321774094/ref=sr_1_2?ie=UTF8&qid=1481349372&sr=8-2&keywords=scala+for+the+impatient](https://www.amazon.com/Scala-Impatient-Cay-S-Horstmann/dp/0321774094/ref=sr_1_2?ie=UTF8&qid=1481349372&sr=8-2&keywords=scala+for+the+impatient)
- **Building Docker Images** - 
  [https://docs.docker.com/engine/getstarted/step_four/](https://docs.docker.com/engine/getstarted/step_four/)
- **Docker Basics (still using boot2docker)** - 
  [https://www.conetix.com.au/blog/docker-basics-practical-starters-guide](https://www.conetix.com.au/blog/docker-basics-practical-starters-guide)
- **Docker Remote API** - 
  [https://docs.docker.com/engine/reference/api/docker_remote_api/](https://docs.docker.com/engine/reference/api/docker_remote_api/)
- **Scala Docker Remote API (Tugboat)** - 
  [https://github.com/softprops/tugboat](https://github.com/softprops/tugboat)
- **Gradle Docker Plugin by Gesellix** - 
  [https://github.com/gesellix/gradle-docker-plugin](https://github.com/gesellix/gradle-docker-plugin)

I hope the above will give some starting-points for ultimately piecing 
together information for this post.

## What We Are Building

To limit the scope of this blog to its original illustrative purposes, we limit to building
the following four Groovy tasks:

### Task `DockerBuild` - Builds a Docker Image

### Task `DockerRun` - Runs a DockerImage

### Task `DockerStop` - Stopping a Running Container

### Task `DockerPublish` - Publishes a Container


## Gradle Concepts


## Docker API

## Building a Docker Image

## Running a Docker Image

## Making Docker-Compose Work

## Packaging and Distributing a Gradle Plugin


## Summary

## References
